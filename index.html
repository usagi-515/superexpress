<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>新幹線シミュレーション（のぞみ）</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <style>
    #map { height: 600px; }
    .train-icon svg {
      width: 30px; height: 30px;
      filter: drop-shadow(0 1px 2px rgba(0,0,0,.3));
      transition: transform 0.2s linear;
    }
    .train-body { fill: #ffffff; stroke: #0f172a; stroke-width: 2; }
    .train-window { fill: #60a5fa; }
    .train-nose { fill: #94a3b8; }
  </style>
</head>
<body>
  <h2>のぞみシミュレーション（東京〜博多）</h2>
  <div id="map"></div>

  <script>
    // ---- 駅座標 ----
    const stations = {
      "東京":[35.681236,139.767125],
      "品川":[35.628710,139.738604],
      "新横浜":[35.507456,139.617585],
      "名古屋":[35.170915,136.881537],
      "京都":[34.985197,135.758997],
      "新大阪":[34.733453,135.500173],
      "岡山":[34.6661,133.9177],
      "広島":[34.3975,132.4755],
      "小倉":[33.8871,130.8830],
      "博多":[33.590354,130.420031]
    };

    let sectionTimes = null;
    let departures = null;
    let trains = [];

    // ---- ファイル読み込み ----
    Promise.all([
      fetch("section_times.json").then(r => r.json()),
      fetch("nozomi_departures.json").then(r => r.json())
    ]).then(([sec, dep]) => {
      sectionTimes = sec;
      departures = dep;
      initMap();
      initTrains();
      setInterval(updateTrains, 1000);
    });

    // ---- 地図 ----
    let map;
    function initMap() {
      map = L.map('map').setView([35.0,137.0],6);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
        { maxZoom: 18 }).addTo(map);

      for (const s in stations) {
        L.marker(stations[s]).addTo(map).bindPopup(s);
      }
    }

    // ---- 列車初期化 ----
    function initTrains() {
      departures.forEach(dep => {
        const schedule = buildSchedule(dep);
        const marker = L.marker(stations["東京"], {
          icon: makeTrainIcon(dep.name)
        }).addTo(map).bindPopup(dep.name);
        trains.push({name: dep.name, schedule, marker});
      });
    }

    // ---- 出発時刻＋区間時間からスケジュールを展開 ----
    function buildSchedule(dep) {
      const sched = [];
      let t = parseTime(dep.dep);
      sched.push({station:"東京", time:new Date(t)});
      sectionTimes.down.forEach(sec => {
        t = new Date(t.getTime() + sec.time*60000);
        sched.push({station: sec.to, time: new Date(t)});
      });
      return sched;
    }

    // ---- 時刻パース ----
    function parseTime(str) {
      const [h,m] = str.split(":").map(Number);
      const d = new Date();
      d.setHours(h,m,0,0);
      return d;
    }

    // ---- 補間 ----
    function interpolate(p1,p2,ratio){
      return [p1[0]+(p2[0]-p1[0])*ratio, p1[1]+(p2[1]-p1[1])*ratio];
    }

    // ---- SVGアイコン ----
    function makeTrainIcon(label="") {
      const html = `
        <svg viewBox="0 0 64 64">
          <path class="train-body" d="M10 34 L40 34 C53 34 58 30 60 26 L60 22 C58 18 53 14 40 14 L20 14 C14 14 10 18 10 22 Z"/>
          <path class="train-nose" d="M40 34 C55 34 62 28 62 23 C62 20 60 18 57 18 C54 18 50 20 46 22 C42 24 39 28 40 34 Z"/>
          <rect class="train-window" x="22" y="18" width="6" height="6" rx="1.5"/>
          <rect class="train-window" x="30" y="18" width="6" height="6" rx="1.5"/>
          <rect class="train-window" x="38" y="18" width="6" height="6" rx="1.5"/>
        </svg>`;
      return L.divIcon({
        html, className: "train-icon", iconSize:[30,30], iconAnchor:[15,15]
      });
    }

    // ---- 更新 ----
    function updateTrains() {
      const now = new Date();
      trains.forEach(train => {
        const sched = train.schedule;
        for (let i=0; i<sched.length-1; i++) {
          const t1 = sched[i].time;
          const t2 = sched[i+1].time;
          if (now >= t1 && now <= t2) {
            const ratio = (now - t1)/(t2 - t1);
            const from = stations[sched[i].station];
            const to   = stations[sched[i+1].station];
            if (from && to) {
              const pos = interpolate(from,to,ratio);
              train.marker.setLatLng(pos);
              train.marker.setPopupContent(`${train.name}<br>${sched[i].station}→${sched[i+1].station}`);
            }
          }
        }
      });
    }
  </script>
</body>
</html>
